# 병렬 데이터 처리와 성능
내부 반복
- 내부 반복을 이용하면 자바 라이브러리가 스트림 요소의 처리를 제어할 수 있다. 따라서 개발자는 컬렉션 데이터 처리 속도를 높이려고 따로 고민할 필요가 없다. 
- 멀티코어를 활용해서 파이프라인 연산을 할 수 있다. 

병렬 스트림
- 스트림의 요소를 여러 청크로 분리해서 각각의 스레드에서 처리할 수 있도록 하는 스트림
- 순차 스트림에 `parallel()` 메서드를 호출하면 병렬 스트림이 된다
   ```java
   // 아래 코드에서는 parallel로 인해서 
   // 1, 2, 3, 4, 5 가 1개의 스레드에서 
   // 5, 6, 7, 8, 9 가 다른 스레드에서 처리되고
   // 최종적으로 2개의 합이 더해져서 리턴된다
   return Stream.iterate(0, i -> i + 1)
        .limit(n)
        .parallel()
        .reduce(0, Integer::sum);
   ```
- 내부적으로는 `ForkJoinPool`을 사용한다. 
  - 프로세서 수가 반환하는 값에 대응하는 스레드 수를 갖는다
  - `Runtime.getRuntime().availableProcessors();`
- 병렬스트림을 사용할 때에는 공유된 가변 상태를 피해야한다
  - 내부적으로 여러 스레드가 동시에 자원에 접근할 수 있기 때문이다

병렬 스트림 사용하기
- 확신이 서지 않으면 직접 측정하라
- 자동 박싱과 언박싱은 성능을 크게 저하시킬 수 있으므로 박싱을 주의하고, 되도록이면 기본형 특화 스트림을 사용하는것이 좋다
- 순서에 의존하는 연산을 병렬 스트림에서 수행하려면 비싼 비용을 치뤄야한다. 
   - limit, findFirst 등
- 하나의 요소를 처리하는데 드는 비용이 높아질 수록 병렬 스트림으로 성능을 개선할 수 있다
- 최종 연산의 병합 과정이 비싸다면 병렬 스트림의 이익이 사라질 수 있다
- 스트림을 구성하는 자료구조가 적절한지 확인
   - ArrayList: 훌륭함
   - LinkedList: 나쁨 (분할하려면 모든 요소를 탐색해야한다)
   - IntStream.range: 훌륭함
   - Stream.iterate: 나쁨
   - HashSet, TreeSet: 좋음

