# 06. 영속성 어댑터 구현하기
## 의존성 역전
![6-1](/Images/만들면서배우는클린아키텍쳐/6-1.jpg)
특징
- 육각형 아키텍처에서 영속성 어댑터는 애플리케이션에 의해서 호출된다
- 포트는 애플리케이션이 영속성 계층에 의존하도록 하지 않기 위해서 추가한 간접계층이다. 이렇게되면 영속성 계층을 수정해도 코어를 변경해야하는 결과로 이어지지 않는다. 

## 영속성 어댑터의 책임
책임
- 입력을 받는다
- 입력을 데이터베이스 포멧으로 변경한다
- 입력을 데이터베이스로 보낸다
- 데이터베이스 출력을 애플리케이션 포맷으로 매핑한다
- 출력을 반환한다

입력/출력 모델은 포트 인터페이스가 지정한 도메인 엔티티나 데이터베이스 연산 전용 객체가 될 수 있다. 
- 입력 모델은 애플리케이션 코어에 있다. 이때문에 영속성 내부의 변경이 코어에 영향을 미치지 않는다. 

## 포트 인터페이스 나누기
특정 엔티티가 필요로하는 모든 데이터베이스 연산을 하나의 리포지터리 인터페이스에 넣기 보다는 ISP를 바탕으로 분리해보자. 
- 하나에 모든것을 넣게되면 넓은 인터페이스 의존성이 발생한다

![6-3](/Images/만들면서배우는클린아키텍쳐/6-3.jpg)
위 그림과 같이 포트를 나누면 포트의 이름이 포트의 역할을 좀 더 명확하게 표현해줄 수 있다. 

## 영속성 어댑터 나누기
어댑터의 경우도 하나여야 한다는 규칙은 없기 때문에 도메인 클래스 하나당 하나의 어댑터를 구현하는 방법을 사용할 수도 있다. 

애그리거트 하나당 어댑터 하나를 구현하는 방법을 택할 수도 있다. 
![6-5](/Images/만들면서배우는클린아키텍쳐/6-5.jpg)

바운디드 컨텍스트는 경계이기 때문에 어떤 맥락이 다른 맥락에 있는 무엇인가를 필요로 한다면 전용 인커밍 포트를 통해 접근해야한다. 

## 스프링 데이터 JPA 
육각형 아키텍처를 구현하면 도메인에 도메인 모델이 존재하고, 영속성 계층에 영속성 모델이 존재한다. 이 둘은 서로 양방향 매핑이 존재한다. 

그냥 도메인 모델만 사용하면 안될까?
- 이 경우에는 JPA로 인해서 도메인 모델이 오염되는 것을 타협할 수 밖에 없다
- 도메인 모델에 JPA 관련 애너테이션이 추가되고, 기본 생성자도 추가되어야한다. 

영속성 측면과의 타협없이 풍부한 도메인 모델을 생성하고 싶다면 도메인 모델과 영속성 모델을 매핑하는 것이 좋다. 

## 트랜잭션은 어떻게 해야할까?
트랜잭션은 하나의 유스케이스에서 일어나는 모든 쓰기 작업에 대해서 걸쳐있어야한다. 
- 영속성 계층은 어떤 연산이 같은 유스케이스에 포함되는지 알지 못하기 때문에 언제 트랜잭션을 열고 닫아야할지 결정할 수 없다. 

## 생각
헥소고날 아키텍처에서 서로 다른 바운디드 컨텍스트에 있는 데이터 조회는 어떻게 해야할까?

