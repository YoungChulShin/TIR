# OAuth2가 작동하는 방법
## OAuth2 프레임워크
OAuth2를 권한부여 프레임워크라고 부르기도 한다. 라이브러리는 아니면 프레임워크이다. 

Basic 인증의 문제점
- 모든 요청에 자격 증명을 보내야한다. 
- 자격증명이 별도의 서버에 있을 경우에 클라이언트가 자격 증명 정보를 저장해서 사용할 수 있다. 

자격증명 서버는 별도의 시스템에서 관리하는 것이 바람직하다. 
![12-3](/Images/스프링시큐티리인액션/12-3.jpg)

결국은 리소스에 접근하기 위한 토큰을 발급해야한다. 

## OAuth2 인증 아키텍처의 구성 요소
구성 요소
- 리소스 서버: 사용자가 소유한 리소스를 호스팅하는 서버. 일반적인 시비스 서버.
- 사용자(또는 리소스 소유자): 리소스 서버가 노출하는 리소스를 소유하는 개인. 
- 클라이언트: 사용자를 대신해서 소유한 리소스에 접근하는 애플리케이션.
- 권한 부여 서버: 클라이언트가 리소스 서버가 노출하는 사용자의 리소스에 접근할 권한을 부여하는 애플리케이션.
![12-4](/Images/스프링시큐티리인액션/12-4.jpg)

## OAuth2를 구현하는 방법 선택
grant_type
- authorization_code
- password
- client_credentials
- refresh_token

### authorization_code grant
프로세스
![12-5](/Images/스프링시큐티리인액션/12-5.jpg)
1. 인증 요청을 한다.
   - 클라이언트는 사용자를 권한부여 서버로 리디렉션 할 때 아래 정보를 포함해서 권한 부여 서버로 전달한다.
      - reponse_type: 클라이언트가 코드를 필요한다는 것을 알린다.
      - client_id: 클라이언트 고유 ID.
      - redirect_url: 인증 성공 후, 사용자를 리디렉션 할 위치를 권한부여 서버에 알려준다. 
      - scope
      - state: csrf 보호를 위한 토큰 정의
   - 인증에 성공하면 권한부여 서버는 리다이렉션 url로 클라이언트를 호출하고, (승인)코드와 상태(state) 값을 제공한다. 
   - 클라이언트는 state 값이 요청을 보낸 것과 같은지 비교한다.
2. 엑세스 토큰을 얻는다. 
   - 클라이언트가 권한부여서버에 토큰을 요청한다.
      - code: 1단계에서 받은 승인 코드.
      - client_id, client_secret: 클라이언트 자격증명
      - redirect_uri
      - grant_type: authorization_code
   - 엑세스 토큰을 응답한다.
3. 보호된 리소스를 호출한다. 
   - 엑세서 토큰을 이용해서 보호된 리소스를 호출한다. 

특징
- 클라이언트는 사용자의 요청을 권한부여서버로 리디렉션한다. 
- 권한 부여 서버는 인증정보가 맞다면 클라이언트로 인증 결과를 알려준다.
- 사용자가 클라이언트에게 자신의 자격증명을 클라이언트와 공유하지 않아도 클라이언트가 특정 작업을 실행하도록 허가할 수 있다는 장점이 있다. 

### password grant
프로세스
![12-7](/Images/스프링시큐티리인액션/12-7.jpg)
1. password grant 유형으로 액세스 토큰을 요청한다. 
   - 클라이언트는 사용자로부터 자격 증명을 수집하고(예: 로그인 화면), 권한부여 서버를 호출한다. 
      - grant_type: password
      - client_id, client_secret: 클라이언트 자격증명
      - scope: 허가된 권한
      - username, password: 사용자 자격증명. 일반 텍스트 형식으로 요청의 헤더 값으로 전송된다. 
   - 권한 부여 서버는 토큰을 응답한다.
2. 엑세스 토큰을 이용해 리소스를 호출한다. 

특징
- 클라이언트와 권한 부여 서버를 같은 조직에서 구축하고 유지 관리할 때만 이용한다. 
- 애플리케이션이 사용자에게 로그인 양식을 보여주고 클라이언트가 서버에게 자격증명을 보내서 인증 과정을 처리한다. 
- 사용자는 애플리케이션에서 인증 책임을 어떻게 설계했는지 알 필요가 없다. 

### client_credential grant
프로세스
![12-8](/Images/스프링시큐티리인액션/12-8.jpg)
1. client_credential grant 유형으로 엑세스 토큰을 요청한다. 
   - grant_type: client_credential
   - client_id, client_secret: 클라이언트 자격증명
   - scope
2. 엑세스 토큰을 이용해서 리소스를 호출한다. 

특징
- OAuth2가 지원하는 가장 단순한 그랜트 유형.
- 사용자가 관여하지 않는 두 애플리케이션 간의 인증을 구현할 때 이용할 수 있다. 
   - 예: msa에서 A 서버가 B 서버를 호출할 때 사용할 수 있다.

### refresh_token grant
프로세스
![12-9](/Images/스프링시큐티리인액션/12-9.jpg)
- 

Access token
- OAuth2의 결과는 grant라고 부르는 엑세스 토큰을 획득하는 것이지만, 특정 토큰의 구현을 가정하지는 않는다. 
- 토큰은 구현 방법과 관계없이 만료될 수도 있고, 수명을 무한하게 할 수도 있다. 가능하면 최소한의 수명을 가지도록 한다. 

Refresh Token
- 권한 부여 서버는 토큰이 만료되었을 때 재인증할 필요를 없애기 위해서 액세스 토큰과는 값과 용도가 다른 갱신 토큰을 발행할 수 있다. 
- 앱은 갱신 토큰으로 재인증 없이 새 액세스 토큰을 얻을 수 있다. 