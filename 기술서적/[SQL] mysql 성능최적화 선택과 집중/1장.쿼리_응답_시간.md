# 쿼리 응답 시간
쿼리 응답 시간
- mysql이 쿼리를 실행할 때 소요되는 시간.
- 같은 의미로 '응답 시간', '쿼리 실행', '실행 시간' 이라고도 한다. 

소요 시간
- mysql이 쿼리를 받았을 때 시작되고 결과 세트를 클라이언트에 전송한 시점까지의 경과 시간.

## 쿼리 보고(report)
쿼리 메트릭은 응답시간, 잠금시간, 조회된 행 등 중요한 정보를 제공한다. 

### 소스
쿼리 메트릭은 `슬로 쿼리 로그`, `성능 스키마`(='performance_schema'와 같은 이름의 데이터 베이스)에서 비롯된다. 

8.0.14 이전 버전의 슬로 쿼리 
- `Query_time`, `Lock_time`, `Rows_sent`, `Rows_examined` 와 같은 4가지 메트릭만을 제공한다. 

### 집계
쿼리 메트릭은 쿼리 별로 그룹화되고 집계된다. 이때 쿼리별로 어떻게 그룹화해서 집계하느냐가 중요하다. 

mysql은 정규화된 sql문을 hash로 변환하는 방법을 사용한다. 
```sql
# 1. 일반 SQL
select col from tbl where id = 1;

# 2. 다이제스트 텍스트 - 정규화된 SQL 문
select 'col' from 'tbl' where 'id' = ?;

# 3. 다이제스트 해시 - SHA-256
f4023ljdlflsjdf23094-123podapofiadspofipoa-0234p23oi4po234opiopiop
```

## 쿼리 분석
쿼리 분석의 목표는 느린 응답 시간을 해결하는 것이 아니라 '쿼리 실행'을 이해하려는 것이다. 

### 쿼리 메트릭
쿼리 시간(query time)
- 잠금 시간을 포함한다.

잠금 시간(lock time)
- 잠금 관리
   - 서버는 테이블과 테이블락 을 관리한다. 
   - 로우레벨 락은 이 잠금이 지원되는 스토리지 엔진에서 관리한다.
   - 메타데이터 락
      - 서버에서 관리한다. 
      - 스키마, 테이블, 스토어드 프로시저 등의 접근을 제어한다. 
      - 테이블 락과 로우 락은 테이블 데이터에 대한 접근 제어하지만, 메타데이터 락은 테이블 구조(열, 인덱스)에 대한 접근을 제어하여 쿼리가 테이블에 접근하는 동안 변경되는 것을 방지한다. 
      - 모든 쿼리는 접근하는 모든 테이블을 대상으로 메타데이터 락을 획득하고, 쿼리가 아닌 트랜잭션이 끝날 때 해제된다. 
- 슬로 쿼리 잠금 시간에는 메타데이터, 레이블, 로우 같은 모든 락 대기가 포함된다. 
- 테이블의 데이터를 변경하거나 작성하기 전에 행을 잠가야 하므로 잠금은 주로 쓰기에 사용된다. 
- __`alter table..algorithm=inplace, lock=none` 과 같은 온라인 스키마 도구를 사용해서 새 테이블 구조로 교체하려면 베타 메타데이터 락을 획득해야 한다.__
   - 테이블 교체는 매우 빠르지만 락이 유지되는 동안 모든 테이블 접근이 차단되므로 부하가 많을 때는 중단 현상이 눈에 띄게 발생할 수 있다. 


## 메타데이터와 애플리케이션
### 평균
쿼리 수가 작거나 값의 분포를 모른다면 평균 응답시간은 왜곡될 수 있기 때문에 주의해야 한다. 

### 백분위수
평균이 갖는 문제를 보완한다. 

예: P95가 100ms
- 값의 95%가 100ms 작거나 같다. 
- 값의 5%가 100ms 보다 크다. 

### 최대 
p99에서 문제가 없다고 해도 1%는 문제를 겪고 있다. 이를 확인하고 수정하는 것이 중요하다. 


## 쿼리 응답 시간 개선
### 직접 쿼리 최적화
직접 쿼리 최적화는 쿼리와 인덱스를 변경하는 것이다. 

mysql select 문 최적화 하기: https://dev.mysql.com/doc/refman/8.3/en/select-optimization.html

### 간접 쿼리 최적화
데이터와 접근 패턴을 변경하는 것이다. 쿼리 변경 대신 쿼리가 접근하는 대상과 방법을 변경한다. 

간접 쿼리 최적화는 직접 쿼리 최적화로 문제가 해결 안되면 시도해본다. 