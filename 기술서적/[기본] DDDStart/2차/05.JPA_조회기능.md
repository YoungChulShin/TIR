# 5. 스프링 데이터 JPA를 이용한 조회기능

_5장은 Criteria를 사용하는 것을 전제로 두는데 우리는 실무에서는 사용하지 않기 때문애 큰 의미가 있는 장은 아닌것 같다._

## 5.2 검색을 위한 스펙
스펙 인터페이스
```java
public interface Specification<T> {
    public boolean isSatisfiedBy(T agg);
}
```
- 1개의 쿼리의 결과를 스펙을 이용해서 다양한 조합을 만들 수 있는 장점
- 다만 전체 데이터를 조회한 뒤에 메모리에서 이 값을 비교하기 때문에 전체 상황에 쓸 수 있는 방법은 아니다

## 5.3 Spring Data Jpa를 이용한 스펙 구현
개념
- `Speficication<T>` 클래스를 이용하면 Criteria API에서 조건을 표현하는 Predicate를 생성한다
   ```java
   // Speficication<T>
   @Nullable
   Predicate toPredicate(Root<T> root, CriteriaQuery<?> query, CriteriaBuilder criteriaBuilder);


   // Predicate
   public interface Predicate extends Expression<Boolean>

   // Expression - Type for query expressions.
   ```

queryDsl
- `BooleanExpresion` 을 이용해서 쿼리 조합이 가능하다
   <!-- ```java
   default BooleanExpression isEmployed() {
    return QAgent.agent.deletedAt.isNull()
        .and(QAgent.agent.owner.dormantAt.isNull())
        .and(QAgent.agent.employmentStatus.eq(EMPLOYED));
  }
   ``` -->

## 5.4 리포지터리/DAO에서 스펙 사용하기
Repository에서 사용
- query method에 Speficiation을 넘겨준다
   ```kotlin
   fun findAll(spec: Specification<Order>) : List<Order>
   ```

queryDsl
- method에 BooleanExpression을 넘겨주면 될 것 같다
- _우리는 repository를 domain에 구현하는데, querydsl의 BooleanExpression이 들어가는게 좋아보이지는 않아서 아는 사용해본적은 없다_

## 5.5 스펙 조합
개념
- `Specification<T>`가 제공하는 조합(and, or) 기능을 이용해서 n개의 스펙을 조합할 수 있다
   ```java
   default Specification<T> and(@Nullable Specification<T> other) {
		return SpecificationComposition.composed(this, other, CriteriaBuilder::and);
   }
   ```
- null 가능성이 있는 스펙은 매번 null 검사를 해야하는 불편함이 있는데, where 메서드를 사용해서 간편하게 대응할 수 있다
   - null이건 조건에 반영이 안되는 방식
      ```java
      static <T> Specification<T> where(@Nullable Specification<T> spec) {
		return spec == null ? (root, query, builder) -> null : spec;
	  }
      ```

queryDsl
- 스펙조합은 BooleanExpression을 이용해서 가능하다. null 허용도 동일하게 처리된다. 
   ```java
   public BooleanExpression and(@Nullable Predicate right) {
        right = (Predicate) ExpressionUtils.extract(right);
        if (right != null) {
            return Expressions.booleanOperation(Ops.AND, mixin, right);
        } else {
            return this;
        }
   }
   ```
   ```java
   default BooleanExpression isEmployed() {
    return QAgent.agent.deletedAt.isNull()
        .and(QAgent.agent.owner.dormantAt.isNull())
        .and(QAgent.agent.employmentStatus.eq(EMPLOYED));
   }
   ```