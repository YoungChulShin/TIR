# 애그리거트 트랜잭션
## 선점 잠금(Pessimistic Lock)
스레드 1에서 잠금을 구하면, 스레드 2에서는 스레드1의 잠금이 풀릴 때(=트랜잭션 커밋)까지 블로킹된다.

DBMS에서 제공하는 행 단위 잠긍 사용해서 구현된다. `for update` 와 같은 쿼리를 사용해서 특정 레코드에 한 사용자만 접급할 수 있도록 잠금 장치를 제공한다. 

데드라 발생 케이스
1. 스레드1: A 애그리거트에 잠금 구함
1. 스레드2: B 애그리거트에 잠금 구함
1. 스레드1: B 애그리거트에 잠금 시도  <- 스레드 2가 잠금을 가지고 있으므로 대기
1. 스레드2: A 애그리거트에 잠금 시도  <- 스레드 1이 잠금을 가지고 있으므로 대기

잠금을 구할 때 최대 대기 시간을 설정해서 문제를 피할 수 있다. JPA에서 제공하는 기능은 DBMS에 따라 적용 여부가 다르니 꼭 미리 확인해보고 적용한다. 

## 비선점 잠금
잠금을 해서 동시에 접근하는 것을 막는 대신 변경한 데이터를 DBMS에 반영하려고 할 때 변경 가능 여부를 확인하는 방식이다. 



