# 9. 코드 리뷰
## 9.1 코드 리뷰 흐름
구글에서는 변경을 코드베이스에 커밋하기 전에 (리뷰를) 수행합니다. 이 단계를 프리커밋 리뷰라고 합니다. 

코드 리뷰의 최종 목표는 다른 엔지니어로부터 해당 변경을 적용해도 된다는 합의를 이끌어내는 것입니다. 합의한 엔지니어는 LGTM라는 태그를 달아 의사를 표시합니다. 

보통은 모든 리뷰어가 LGTM을 달아주는게 관례지만 원칙적으로는 한 개만 얻어도 됩니다. 

__코드 리뷰는 전에 내린 설계를 변복하거나 재논의하는 자리여서는 안 됩니다.__ 설계를 결정하는 데는 보통 시간이 걸립니다. 새로운 설계 후보를 수차례 토론하고 프로토타입을 만들어보기도 하죠. 전혀 새로운 코드를 리뷰하는 일이 뜬금없이 생겨서는 안 되듯이, 코드 리뷰 과정 자체를 기존 결정을 다시 논의할 기회로 보아서는 안됩니다. 


## 9.2 코드 리뷰 @ 구글
__구글에서는 어떤 변경이든 승인을 얻으러면 세 가지 측면에서의 리뷰를 통과해야합니다.__
1. 다른 엔지니어로부터 정확성과 이해 용이성을 평가받습니다. 필수는 아니지만 이 평가는 팀원이 해주는 경우가 많습니다. 
2. 변경 되는 코드 영역을 관리하는 코드 소유자로부터 변경 코드가 적절하다는 승인을 받습니다. 
3. 누군가로부터 '가독성' 승인을 받습니다. 

하지만 대부분 리뷰는 세 역할을 수행할 수 있는 사람 한 명이 처리하기 때문에 이 절차들이 빠르게 진행됩니다. 

실제로 승인을 두 개 이상 얻어야하는 코드 리뷰 대부분은 두 단계로 진행됩니다. 먼저 동료 엔지니어로부터 LGTM을 받고, 그 다음으로 해당 코드 소유자와 가독성 인증자에게 승인을 요청합니다. 이 방식은 참여하는 두 역할의 사람들이 각지 다른 측면에 집중해 리뷰하도록 해주어 시간을 절약해줍니다. 첫 번째 리뷰어인 동료 엔지니어는 코드가 정확한지와 변경된 코드가 유효한지에 집중합니다. 이어서 코드 소유자는 한 줄 한 줄 상세히 살펴보는 대신 자신이 맡은 코드베이스에 적합한 변경인지에 집중합니다. 승인자는 동료 리뷰어와 다른 관점에서 코드를 살펴보는 것입니다. 

## 9.3 코드 리뷰의 이점
코드 리뷰는 구글의 소프트웨어 엔지니어 모두가 반드시 따라야하는 몇 안 되는 전사적인 프로세스입니다. 구글은 아무리 작더라도 코드베이스를 수정하는 거의 모든 변경에 코드 리뷰를 요구합니다. 이러한 경제적인 규제는 비용을 유발하고 엔지니어링 속도에도 영향을 줍니다. 

__잘 설계된 코드리뷰 프로세스와 코드 리뷰를 중요하게 다루는 문화가 주는 대표적인 이점은 다음과 같습니다.__
- 코드가 정확한지 확인해줍니다. 
- 변경된 코드를 다른 엔지니어도 잘 이해합니다. 
- 코드베이스가 일관되게 관리됩니다. 
- 팀이 소유권을 더 강하게 느낍니다. 
- 지식이 공유됩니다. 
- 코드 리뷰 자체의 기록이 남습니다. 

### 코드 정확성
__리뷰어는 일차적으로 변경된 코드의 '정확성'을 확인해주며, 코드 리뷰가 주는 가장 확실한 이점입니다.__ 변화를 주시하는 시선이 하나 더 있다는 사실은 변경이 의도대로 이루어지도록 하는데 도움을 줍니다. 리뷰어는 일반적으로 해당 변경에 적합한 테스트가 갖춰졌는지, 설계는 적절한지, 정확하게 동작하고 효율적인지를 살핍니다. 또한 정확한 검사는 변경이 코드베이스에 버그를 심지 않도록 걸러주는 역할도 합니다. 

__물론 코드 리뷰 프로세스 자체를 단순화하여 가볍게 유지해야만 합니다. 사실 이게 핵심입니다.__ 프로세스가 무겁거나 확장하기 어렵다면 코드 리뷰를 지속할 수 없습니다. 
- 정확한 평가가 주관적으로 흘러가지 않도록 하기 위한 일반적으로 변경 작성자가 선택한 방식을 존중해줍니다. 설계측면에서든 기능측면에서든 마찬가지입니다. 
- 리뷰어는 자신이 선호한다는 이유로 다른 안을 주장해서는 안 됩니다. 물론 리뷰어가 대안을 제시하는 건 가능하지만 이해하기 쉽거나 기능을 개선하는 대안일 경우에만 그리 해야 합니다. 
- 구글은 새로운 코드가 '완벽하다'고 합의될 때까지 기다리지 않고 코드베이스를 개선한다고 인정되면 변경을 승인하도록 안내합니다. 코드 리뷰의 속도를 높이는 수단 중 하나입니다. 

__코드 리뷰는 소프트웨어 개발에서 결합에 대처하는 여러 방어 수단 중 한 축입니다. 하지만 만능 치트키도 아니고 정확성을 검사하는 유일한 수단도 물론 아닙니다. 따라서 코드 리뷰가 '완벽'할 필요까지는 없습니다.__

### 코드 이해 용이성
최고의 엔지니어라도 혼자서는 할 수 없는 일을 해줄 수 있습니다. 바로 작성자의 관점에 치우치지 않는 피드벡을 제공하는 일입니다. 코드 리뷰는 주어진 변경이 수많은 다른 사람에게도 쉽게 이해되는지를 평가하는 첫 번째 시험대입니다. 

리뷰어는 작성자가 선택한 설계를 존중해야 합니다. 하지만 그와 별개로, 코드가 잘 이해되지 않으면 '고객은 항상 옳다'는 관점에서 질문을 던저보는 건 좋습니다. 리뷰어의 의문 하나하나는 시간이 지날수록 가치가 몇 배는 커질 것이므로 질문을 하는 게 맞다고 생각합니다. 

### 코드 일관성
가독성 승인자의 임무는 주어진 코드가 다음 사항들을 잘 만족하는지를 검토하는 것입니다. 
- 해당 프로그래밍 언어의 모범 사례들을 잘 따라야합니다. 
- 구글 코드 리포지토리에서 같은 언어로 작성된 다른 코드들과 일관되어야 합니다. 
- 필요 이상으로 복잡하지 않아야 합니다. 

때로은 일관성을 위해 기능성을 희생해야 할 때도 있습니다. 

### 심리적, 문화적 이점
코드 리뷰를 하지 않는다면 대다수 엔지니어가 자연스럽게 각자의 취향대로 소프트웨어를 설계하게 됩니다. 

자신의 솜씨를 뽐내고 싶고 비판받는 자리에 자신의 코드를 내어놓고 싶어 하지 않는 것이 사람의 본성입니다. 자신의 코드에 비판적 피드백이 달갑지 않은 것 역시 당연합니다. 
- 코드 리뷰는 이럴 때 자칫 감정적으로 번질 수 있는 논쟁을 건전하게 만들어줍니다. 
- 코드 리뷰가 제대로 작동한다면 작성자가 당연하게 여기던 가정이 틀릴 수 있음을 사전에 규정된 중립적인 방식으로 지적할 수 있습니다. 

__코드 리뷰라는 장치가 없다면 우리 중 많은 수가 자연스럽게 절차를 무시하려 들 것입니다.__ 사소한 결함은 나중에 해결하겠다는 안이함으로 말이죠. 가령 '단위 테스트가 충분하지 않은 건 인정해. 하지만 나중에 할 거야'라고 말하는 모습을 보게 됩니다. 

### 지식 공유
리뷰 프로세스는 제안, 신기술 소개, 조언을 통해 리뷰어가 변경 작성자에게 도메인 지식을 전파하도록 이끌어줍니다. 

## 9.4 코드 리뷰 모범 사례
### 공손하고 전문가답게
일반적으로 리뷰어들은 작성자가 선택한 방식을 존중하고 오직 그 방식에 결함이 있을 때만 대안을 제시해야 합니다.
- 작성자가 다른 대안 중 특별히 더 우수한게 없음을 설명할 수 있다면 리뷰어들은 작성자의 취향을 받아들여야 합니다. 
- 모든 논평은 철저히 전문적이어야 합니다. 
- 리뷰어는 작성자의 방식에 대해 성급히 결론짓지 않게 주의해야 합니다. 그 방식이 잘못되었다고 가정하기 전에 그렇게 처리하게 된 이유가 무엇인지부터 물어보는 게 좋습니다. 

__리뷰어는 신속하게 피드백해야합니다.__
- 구글에서는 코드 리뷰 피드백이 24시간 내에 올 거라 기대합니다. 
- 그 안에 피드백하지 못할 것 같은 리뷰어는 '변경을 확인했고, 최대한 조속히 검토해보겠다'라고 응답해주는게 좋습니다. 
- 너무 단편적인 피드백은 삼가야 합니다. 

코드 리뷰 과정에서 리뷰어가 단 댓글은 모두 할 일 (TODO)로 취급해야 합니다. 댓글을 의문 없이 수용할 필요는 없지만, 적어도 고민은 해봐야 합니다. 

### 작게 변경하기
코드 리뷰 프로세스를 날렵하게 가져가기 위해 가장 중요한 모범 사례를 여쭤보면 저는 변경을 작게 만들라고 답할 것입니다. 

그럼에도 커다란 기능을 새로 도입할 때는 작은 변경들로 대응하기가 어렵습니다. 작게 나눠진 변경들을 하나씩 소화하기에는 쉽지만 전체 그림 안에서 종합적으로 검토하기는 더 어렵습니다. 

'작은' 변경이라 하면 일반적으로 변경되는 코드가 약 200줄 이하라는 뜻입니다. 

### 변경 설명 잘 쓰기
변경 설명의 첫 줄은 어떤 종류의 변경인지를 잘 요약해야 합니다. 

### 리뷰어는 최소한으로
리뷰어 한명이 추가될 때마다 새로운 시각이 한 스푼씩 더해지며, 결국 수확 체감으로 이어집니다. 우리는 첫 번째 LGTM이 가장 중요하며, 두 번째부터는 크게 신경 쓸 만큼의 가치가 없다는 걸 발견했습니다. 리뷰어를 추가해서 얻는 가치보다 비용이 훨씬 빠르게 증가하여 금세 역전됩니다. 

### 가능한 자동화하기
프로세스 중 자동화할 수 있는 요소가 있다면 자동화하세요. 

## 9.5 코드 리뷰 유형
### 그린필드 코드 리뷰
그린필드 리뷰: 와전히 새로운 코드를 대상으로 하는 가장 드문 유형의 코드 리뷰.

구글에서는 보통 새로운 코드나 프로젝트에는 코드 리뷰와 별개로 설계 리뷰를 강도 높게 진행합니다. 따라서 코드 리뷰는 이미 결정된 설계에 관해서 왈가불가 하는 시간이 아닙니다. 같은 이유에서 대안 설계를 제시하는 자리도 아닙니다. 

### 동작 변경, 개선, 최적화
죽은 코드나 낡은 코드 제거는 코드베이스를 전반적으로 건실하게 만드는 아주 멋진 방법입니다. 

API의 동작을 수정할 때는 변경된 동작에 맞게 관련 테스트도 합께 수정해야 합니다. 

### 버그 수정과 롤백
버그를 수정하면서 다른 문제까지 묶어 처리하고픈 마음을 꾹 눌러야합니다. 버그 수정은 온전히 버그를 잡는 데만 집중합시다. 

